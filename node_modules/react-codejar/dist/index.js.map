{"version":3,"file":"index.js","sources":["../src/caret.ts","../src/index.tsx"],"sourcesContent":["// Took from https://stackoverflow.com/questions/4811822/get-a-ranges-start-and-end-offsets-relative-to-its-parent-container/4812022#4812022\nexport const getCaretOffset = (element: HTMLDivElement) => {\n  let caretOffset = 0;\n  const doc = element.ownerDocument || (element as any).document;\n  const win = doc.defaultView || doc.parentWindow;\n  let sel;\n  if (typeof win.getSelection != \"undefined\") {\n    sel = win.getSelection();\n    if (sel.rangeCount > 0) {\n      var range = win.getSelection().getRangeAt(0);\n      var preCaretRange = range.cloneRange();\n      preCaretRange.selectNodeContents(element);\n      preCaretRange.setEnd(range.endContainer, range.endOffset);\n      caretOffset = preCaretRange.toString().length;\n    }\n  } else if ((sel = doc.selection) && sel.type != \"Control\") {\n    var textRange = sel.createRange();\n    var preCaretTextRange = doc.body.createTextRange();\n    preCaretTextRange.moveToElementText(element);\n    preCaretTextRange.setEndPoint(\"EndToEnd\", textRange);\n    caretOffset = preCaretTextRange.text.length;\n  }\n  return caretOffset;\n};\n\n// Took from https://jsfiddle.net/nrx9yvw9/5/\nconst createRange = (\n  el: ChildNode,\n  chars: { count: number },\n  range?: Range\n): Range => {\n  if (!range) {\n    range = document.createRange();\n    range.selectNode(el);\n    range.setStart(el, 0);\n  }\n\n  if (chars.count === 0) {\n    range.setEnd(el, chars.count);\n  } else if (el && chars.count > 0) {\n    if (el.nodeType === Node.TEXT_NODE) {\n      if (el.textContent!.length < chars.count) {\n        chars.count -= el.textContent!.length;\n      } else {\n        range.setEnd(el, chars.count);\n        chars.count = 0;\n      }\n    } else {\n      for (var i = 0; i < el.childNodes.length; i++) {\n        range = createRange(el.childNodes[i], chars, range);\n\n        if (chars.count === 0) {\n          break;\n        }\n      }\n    }\n  }\n\n  return range;\n};\n\nexport const setCurrentCursorPosition = (el: HTMLDivElement, chars: any) => {\n  if (chars >= 0) {\n    const selection = window.getSelection();\n\n    const range = createRange(el, { count: chars });\n\n    if (range) {\n      range.collapse(false);\n      selection!.removeAllRanges();\n      selection!.addRange(range);\n    }\n  }\n};\n","import * as React from \"react\";\nimport { CodeJar } from \"codejar\";\nimport { withLineNumbers } from \"codejar/linenumbers\";\nimport { getCaretOffset, setCurrentCursorPosition } from \"./caret\";\n\ntype CodejarOptions = {\n  tab: string;\n  indentOn: RegExp;\n  spellcheck: boolean;\n  catchTab: boolean;\n  preserveIdent: boolean;\n  history: boolean;\n  window: Window;\n  addClosing: boolean;\n};\n\ninterface Props {\n  highlight: (e: HTMLElement) => void;\n  options?: Partial<CodejarOptions>;\n  code: string;\n  style: React.CSSProperties;\n  onUpdate: (code: string) => void;\n  lineNumbers?: boolean;\n}\n\nexport const useCodeJar = (props: Props) => {\n  const editorRef = React.useRef<HTMLDivElement>(null);\n  const jar = React.useRef<CodeJar | null>(null);\n  const [cursorOffset, setCursorOffset] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!editorRef.current) return;\n\n    const highlight = props.lineNumbers\n      ? withLineNumbers(props.highlight)\n      : props.highlight;\n\n    jar.current = CodeJar(editorRef.current, highlight, props.options);\n\n    jar.current.updateCode(props.code);\n\n    jar.current.onUpdate(txt => {\n      if (!editorRef.current) return;\n\n      setCursorOffset(getCaretOffset(editorRef.current));\n      props.onUpdate(txt);\n    });\n\n    return () => jar.current!.destroy();\n  }, []);\n\n  React.useEffect(() => {\n    if (!jar.current || !editorRef.current) return;\n    jar.current.updateCode(props.code);\n    setCurrentCursorPosition(editorRef.current, cursorOffset);\n  }, [props.code]);\n\n  React.useEffect(() => {\n    if (!jar.current || !props.options) return;\n\n    jar.current.updateOptions(props.options);\n  }, [props.options]);\n\n  return editorRef;\n};\n\nexport const ReactCodeJar: React.FC<Props> = props => {\n  const editorRef = useCodeJar(props);\n\n  return <div style={props.style} ref={editorRef}></div>;\n};\n"],"names":["getCaretOffset","element","caretOffset","doc","ownerDocument","document","win","defaultView","parentWindow","sel","getSelection","rangeCount","range","getRangeAt","preCaretRange","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","toString","length","selection","type","textRange","createRange","preCaretTextRange","body","createTextRange","moveToElementText","setEndPoint","text","el","chars","selectNode","setStart","count","nodeType","Node","TEXT_NODE","textContent","i","childNodes","setCurrentCursorPosition","window","collapse","removeAllRanges","addRange","useCodeJar","props","editorRef","React","jar","cursorOffset","setCursorOffset","current","highlight","lineNumbers","withLineNumbers","CodeJar","options","updateCode","code","onUpdate","txt","destroy","updateOptions","ReactCodeJar","style","ref"],"mappings":"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"}